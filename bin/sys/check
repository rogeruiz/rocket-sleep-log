#!/bin/bash

RED='\033[1;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
NC='\033[0m' # No Color

NODE=`which node`
NPM=`which npm`
BOWER=`which bower`
GRUNT=`which grunt`
BROCCOLI=`which broccoli`

FORCE_INSTALL=$1

function print_logo {
  echo -e "${GREEN}✓ ${YELLOW}✓ ${GREEN}✓ ${YELLOW}✓ ${GREEN}✓ ${YELLOW}✓ ${GREEN}✓ ${YELLOW}✓ ${NC}";
  echo -e "${YELLOW}✓ ${GREEN}✓ ${YELLOW}✓ ${GREEN}✓ ${YELLOW}✓ ${GREEN}✓ ${YELLOW}✓ ${GREEN}✓ ${NC}";
  echo -e "${GREEN}✓ ${YELLOW}✓ ${GREEN}✓ ${YELLOW}✓ ${GREEN}✓ ${YELLOW}✓ ${GREEN}✓ ${YELLOW}✓ ${NC}";
}

function install_dependencies {
  if [[ -n $FORCE_INSTALL && $FORCE_INSTALL == '--install' ]]; then
    $1 install;
  else
    echo -e "${YELLOW}[msg]: Do you want to run \`${2}\`${NC}";
    select YN in "Sure" "No, thanks"; do
      case $YN in
        "Sure" ) $1 install; break;;
        "No, thanks" ) break;;
      esac
    done
  fi
}
function install_globals {
  if [[ -n $FORCE_INSTALL && $FORCE_INSTALL == '--install' ]]; then
    npm install --global $1;
    echo "${GREEN}[msg]: Installed ${1}${NC}";
  else
    echo -e "${YELLOW}[msg]: Do you want to run \`npm install --global ${1}\`${NC}";
    select YN in "Sure" "No, thanks"; do
      case $YN in
        "Sure" ) `$1`; break;;
        "No, thanks" ) break;;
      esac
    done
  fi
}

print_logo

# Let's check for Node and NPM and Bower, which are needed for the project.
if [[ $NODE && $NPM && $BOWER ]]; then

  # Let's see if the dependencies have been installed.
  if [[ ! -d ./node_modules && -f ./package.json ]]; then
    install_dependencies $NPM 'npm install'
  fi
  if [[ ! -d ./app/assets/vendor && -f ./bower.json ]]; then
    install_dependencies $BOWER 'bower install'
  fi

  echo -e "${GREEN}[msg]: node: `node -v`${NC}";
  echo -e "${GREEN}[msg]: bower: `bower -v`${NC}";

  if [ ! $BROCCOLI ]; then
    echo -e "${RED}[msg]: Broccoli is not installed!${NC}";
    install_globals 'broccoli-cli'
  else
    echo -e "${GREEN}[msg]: broccoli: `broccoli --version`${NC}";
  fi
  if [ ! $GRUNT ]; then
    echo -e "${RED}[msg]: Grunt is not installed!${NC}";
    install_globals 'grunt-cli'
  else
    echo -e "${GREEN}[msg]: grunt: `echo -n \`grunt --version\``${NC}";
  fi

  echo -e "${YELLOW}[msg]: All good ${GREEN}✓✓✓${NC}";
  exit 0;

# If we don't have Bower but have Node, let's be helpful.
elif [ $NPM ]; then
  if [ ! $BOWER ]; then
    echo -e "${RED}[msg]: Bower is not installed!${NC}";
    install_globals 'bower'
  fi
  if [ ! $BROCCOLI ]; then
    echo -e "${RED}[msg]: Broccoli is not installed!${NC}";
    install_globals 'broccoli-cli'
  fi
  if [ ! $GRUNT ]; then
    echo -e "${RED}[msg]: Grunt is not installed!${NC}";
    install_globals 'grunt-cli'
  fi
  exit 0;

# We can't do much of anything but help.
else
  echo -e "${RED}[msg]: Neither Node nor Bower are installed!${NC}";
  echo -e "${YELLOW}[msg]: Install Node from: http://nodejs.org/${NC}";
  echo -e "${YELLOW}[msg]: Then, install Bower via NPM: \`npm i -g bower\`${NC}";
  exit 1;
fi

